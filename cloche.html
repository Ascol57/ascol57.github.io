<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Soundbox Pro - Anti-Veille</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #1a1a1a;
            color: white;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100vh;
            margin: 0;
            user-select: none;
        }

        h1 { margin-bottom: 30px; letter-spacing: 2px; text-transform: uppercase; font-size: 1.5rem;}

        /* --- Bouton d'activation --- */
        #btn-init {
            background-color: #e74c3c;
            color: white;
            padding: 20px 40px;
            font-size: 18px;
            border: none;
            border-radius: 50px;
            cursor: pointer;
            box-shadow: 0 0 20px rgba(231, 76, 60, 0.6);
            transition: all 0.2s ease;
            margin-bottom: 50px;
            font-weight: bold;
            text-align: center;
        }
        #btn-init:hover { transform: scale(1.05); }
        #btn-init:active { transform: scale(0.95); }
        
        #btn-init.active { 
            background-color: #27ae60; 
            box-shadow: 0 0 20px rgba(39, 174, 96, 0.6);
            cursor: default;
        }

        /* --- Grille des sons --- */
        .sound-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 20px;
            width: 80%;
            max-width: 600px;
        }

        .sound-btn {
            background-color: #34495e;
            color: #bdc3c7;
            border: none;
            padding: 30px 20px;
            font-size: 16px;
            border-radius: 12px;
            cursor: not-allowed;
            transition: all 0.1s;
            position: relative;
            overflow: hidden;
            font-weight: bold;
        }

        .sound-btn.loaded {
            background-color: #3498db;
            color: white;
            cursor: pointer;
            box-shadow: 0 4px 0 #2980b9;
        }

        .sound-btn.loaded:active { 
            transform: translateY(4px);
            box-shadow: 0 0 0 #2980b9; 
            background-color: #5dade2;
        }

        .sound-grid.locked {
            opacity: 0.5;
            pointer-events: none;
        }

        .status { margin-top: 30px; color: #7f8c8d; font-size: 0.8em; font-family: monospace;}
        .status.on { color: #2ecc71; }
    </style>
</head>
<body>

    <h1>ðŸš€ Soundbox Anti-Veille</h1>

    <button id="btn-init" onclick="unlockAudioSystem()">
        CLIQUER POUR ACTIVER<br>
        <small style="font-weight:normal; font-size:0.7em">(Anti-Buzz + Ã‰cran AllumÃ©)</small>
    </button>

    <div class="sound-grid locked" id="grid">
        
        <button class="sound-btn" data-url="https://constant.rusche.fr/ClocheV2.mp3" data-key="cloche">
            Chargement...
        </button>

    </div>

    <div class="status" id="status-text">Initialisation...</div>

    <script>
        // --- 1. CONFIGURATION ---
        const AudioContext = window.AudioContext || window.webkitAudioContext;
        const audioCtx = new AudioContext();
        const soundBuffers = {};
        let wakeLock = null; // Variable pour stocker le verrouillage d'Ã©cran

        // --- 2. FONCTIONS DE CHARGEMENT ---
        async function loadSound(url) {
            try {
                const response = await fetch(url);
                const arrayBuffer = await response.arrayBuffer();
                const audioBuffer = await audioCtx.decodeAudioData(arrayBuffer);
                return audioBuffer;
            } catch (error) {
                console.error("Erreur chargement son:", url, error);
                return null;
            }
        }

        async function initSoundLoader() {
            const buttons = document.querySelectorAll('.sound-btn');
            
            for (const btn of buttons) {
                const url = btn.getAttribute('data-url');
                const key = btn.getAttribute('data-key');
                const buffer = await loadSound(url);

                if (buffer) {
                    soundBuffers[key] = buffer;
                    btn.innerText = key.toUpperCase();
                    btn.classList.add('loaded');
                    btn.onclick = () => playBuffer(key);
                } else {
                    btn.innerText = "ERREUR";
                    btn.style.backgroundColor = "#c0392b";
                }
            }
            document.getElementById('status-text').innerText = "Sons chargÃ©s. En attente d'activation.";
        }

        // --- 3. FONCTION DE LECTURE ---
        function playBuffer(key) {
            if (!soundBuffers[key]) return;
            const source = audioCtx.createBufferSource();
            source.buffer = soundBuffers[key];
            source.connect(audioCtx.destination);
            source.start(0);
        }

        // --- 4. GESTION DE L'ANTI-VEILLE (Wake Lock API) ---
        async function requestWakeLock() {
            try {
                if ('wakeLock' in navigator) {
                    wakeLock = await navigator.wakeLock.request('screen');
                    console.log('Verrouillage Ã©cran actif');
                    return true;
                } else {
                    console.warn("Wake Lock API non supportÃ©e par ce navigateur.");
                    return false;
                }
            } catch (err) {
                console.error(`${err.name}, ${err.message}`);
                return false;
            }
        }

        // --- 5. ACTIVATION DU SYSTÃˆME ---
        async function unlockAudioSystem() {
            // A. Audio
            if (audioCtx.state === 'suspended') {
                audioCtx.resume();
            }

            // B. Anti-Buzz (Oscillateur 19kHz)
            const oscillator = audioCtx.createOscillator();
            const gainNode = audioCtx.createGain();
            oscillator.type = 'sine';
            oscillator.frequency.value = 19000; 
            gainNode.gain.value = 0.00001;      
            oscillator.connect(gainNode);
            gainNode.connect(audioCtx.destination);
            oscillator.start();

            // C. Anti-Veille (Ã‰cran)
            const wakeLockSuccess = await requestWakeLock();

            // D. Interface
            const btnInit = document.getElementById('btn-init');
            btnInit.innerHTML = "SYSTÃˆME ACTIF âœ…";
            btnInit.classList.add('active');
            
            document.getElementById('grid').classList.remove('locked');
            
            const statusText = document.getElementById('status-text');
            statusText.classList.add('on');
            statusText.innerHTML = wakeLockSuccess 
                ? "Audio OK â€¢ Anti-Buzz OK â€¢ Ã‰cran maintenu allumÃ©" 
                : "Audio OK â€¢ Anti-Buzz OK â€¢ (Anti-veille non supportÃ©)";
        }

        // RÃ©activer le Wake Lock si on change d'onglet et qu'on revient
        document.addEventListener('visibilitychange', async () => {
            if (wakeLock !== null && document.visibilityState === 'visible') {
                await requestWakeLock();
            }
        });

        window.addEventListener('load', initSoundLoader);

    </script>
</body>
</html>

